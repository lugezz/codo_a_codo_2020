!function(e){var t,r;"object"==typeof exports&&"function"==typeof require?module.exports=e(require("underscore"),require("backbone")):"function"==typeof define&&define.amd?define(["underscore","backbone"],e):"undefined"!=typeof _&&"undefined"!=typeof Backbone&&(t=Backbone.PageableCollection,r=e(_,Backbone),Backbone.PageableCollection.noConflict=function(){return Backbone.PageableCollection=t,r})}(function(P,c){"use strict";var b=P.extend,p=P.omit,S=P.clone,_=P.each,m=P.pick,f=P.contains,u=P.isEmpty,v=P.pairs,n=P.invert,y=P.isArray,k=P.isFunction,o=P.isObject,R=P.keys,C=P.isUndefined,x=Math.ceil,i=Math.floor,g=Math.max,w=c.Collection.prototype;function h(e,t){if(!P.isNumber(e)||P.isNaN(e)||!P.isFinite(e)||~~e!==e)throw new TypeError("`"+t+"` must be a finite integer");return e}function q(e,t,r){var s,a,t=e._events[t];t&&t.length?(s=t[t.length-1],a=s.callback,s.callback=function(){try{a.apply(this,arguments),r()}catch(e){throw e}finally{s.callback=a}}):r()}var l=/[\s'"]/g,d=/[<>\s'"]/g,e=c.PageableCollection=c.Collection.extend({state:{firstPage:1,lastPage:null,currentPage:null,pageSize:25,totalPages:null,totalRecords:null,sortKey:null,order:-1},mode:"server",queryParams:{currentPage:"page",pageSize:"per_page",totalPages:"total_pages",totalRecords:"total_entries",sortKey:"sort_by",order:"order",directions:{"-1":"asc",1:"desc"}},constructor:function(e,t){w.constructor.apply(this,arguments),t=t||{};var r=this.mode=t.mode||this.mode||z.mode,s=b({},z.queryParams,this.queryParams,t.queryParams||{});s.directions=b({},z.queryParams.directions,this.queryParams.directions,s.directions),this.queryParams=s;var a=this.state=b({},z.state,this.state,t.state);a.currentPage=null==a.currentPage?a.firstPage:a.currentPage,y(e)||(e=e?[e]:[]),e=e.slice(),"server"==r||null!=a.totalRecords||u(e)||(a.totalRecords=e.length),this.switchMode(r,b({fetch:!1,resetState:!1,models:e},t));s=t.comparator;a.sortKey&&!s&&this.setSorting(a.sortKey,a.order,t),"server"!=r&&(r=this.fullCollection,s&&t.full&&(this.comparator=null,r.comparator=s),t.full&&r.sort(),u(e)||(this.reset(e,b({silent:!0},t)),this.getPage(a.currentPage),e.splice.apply(e,[0,e.length].concat(this.models)))),this._initState=S(this.state)},_makeFullCollection:function(e,t){for(var r,s=["url","model","sync","comparator"],a=this.constructor.prototype,i={},n=0,o=s.length;n<o;n++)C(a[r=s[n]])||(i[r]=a[r]);var l=new(c.Collection.extend(i))(e,t);for(n=0,o=s.length;n<o;n++)this[r=s[n]]!==a[r]&&(l[r]=this[r]);return l},_makeCollectionEventHandler:function(y,k){return function(e,t,r,s){var a=y._handlers;_(R(a),function(e){var t=a[e];y.off(e,t),k.off(e,t)});var i,n,o,l,c,u,h,f,g=S(y.state),d=g.firstPage,P=0===d?g.currentPage:g.currentPage-1,p=g.pageSize,m=P*p,v=m+p;"add"==e&&(s=s||{},r==k?m<=(n=k.indexOf(t))&&n<v&&(o=y,i=l=n-m):(n=m+(i=y.indexOf(t)),o=k,l=C(s.at)?n:s.at+m),s.onRemove||(++g.totalRecords,delete s.onRemove),y.state=y._checkState(g),o&&(o.add(t,b({},s,{at:l})),(c=p<=i?t:!C(s.at)&&l<v&&y.length>p?y.at(p):null)&&q(r,e,function(){y.remove(c,{onAdd:!0})})),s.silent||y.trigger("pageable:state:change",y.state)),"remove"==e&&(s.onAdd?delete s.onAdd:(--g.totalRecords?(h=g.totalPages=x(g.totalRecords/p),g.lastPage=0===d?h-1:h||d,g.currentPage>h&&(g.currentPage=g.lastPage)):(g.totalRecords=null,g.totalPages=null),y.state=y._checkState(g),f=s.index,r==y?((u=k.at(v))?q(y,e,function(){y.push(u,{onRemove:!0})}):!y.length&&g.totalRecords&&y.reset(k.models.slice(m-p,v-p),b({},s,{parse:!1})),k.remove(t)):m<=f&&f<v&&((u=k.at(v-1))&&q(y,e,function(){y.push(u,{onRemove:!0})}),y.remove(t),!y.length&&g.totalRecords&&y.reset(k.models.slice(m-p,v-p),b({},s,{parse:!1})))),s.silent||y.trigger("pageable:state:change",y.state)),"reset"==e&&(s=r,(r=t)==y&&null==s.from&&null==s.to?(h=k.models.slice(0,m),f=k.models.slice(m+y.models.length),k.reset(h.concat(y.models).concat(f),s)):r==k&&((g.totalRecords=k.models.length)||(g.totalRecords=null,g.totalPages=null),"client"==y.mode&&(v=(m=(0===(d=g.lastPage=g.currentPage=g.firstPage)?g.currentPage:g.currentPage-1)*p)+p),y.state=y._checkState(g),y.reset(k.models.slice(m,v),b({},s,{parse:!1}))),s.silent||y.trigger("pageable:state:change",y.state)),"sort"==e&&(s=r,(r=t)===k&&y.reset(k.models.slice(m,v),b({},s,{parse:!1}))),_(R(a),function(t){var r=a[t];_([y,k],function(e){e.on(t,r);e=e._events[t]||[];e.unshift(e.pop())})})}},_checkState:function(e){var t=this.mode,r=this.links,s=e.totalRecords,a=e.pageSize,i=e.currentPage,n=e.firstPage,o=e.totalPages;if(null!=s&&null!=a&&null!=i&&null!=n&&("infinite"!=t||r)){if(s=h(s,"totalRecords"),a=h(a,"pageSize"),i=h(i,"currentPage"),n=h(n,"firstPage"),a<1)throw new RangeError("`pageSize` must be >= 1");if(o=e.totalPages=x(s/a),n<0||1<n)throw new RangeError("`firstPage must be 0 or 1`");if(e.lastPage=0===n?g(0,o-1):o||n,"infinite"==t){if(!r[i+""])throw new RangeError("No link found for page "+i)}else if(i<n||0<o&&(n?o<i:o<=i))throw new RangeError("`currentPage` must be firstPage <= currentPage "+(n?"<":"<=")+" totalPages if "+n+"-based. Got "+i+".")}return e},setPageSize:function(e,t){e=h(e,"pageSize"),t=t||{first:!1};var r=this.state,s=x(r.totalRecords/e),a=s?g(r.firstPage,i(s*r.currentPage/r.totalPages)):r.firstPage,r=this.state=this._checkState(b({},r,{pageSize:e,currentPage:t.first?r.firstPage:a,totalPages:s}));return this.getPage(r.currentPage,p(t,["first"]))},switchMode:function(e,t){if(!f(["server","client","infinite"],e))throw new TypeError('`mode` must be one of "server", "client" or "infinite"');t=t||{fetch:!0,resetState:!0};var r=this.state=t.resetState?S(this._initState):this._checkState(b({},this.state));this.mode=e;var s,a,i=this,n=this.fullCollection,o=this._handlers=this._handlers||{};if("server"==e||n?"server"==e&&n&&(_(R(o),function(e){s=o[e],i.off(e,s),n.off(e,s)}),delete this._handlers,this._fullComparator=n.comparator,delete this.fullCollection):(((n=this._makeFullCollection(t.models||[],t)).pageableCollection=this).fullCollection=n,a=this._makeCollectionEventHandler(this,n),_(["add","remove","reset","sort"],function(e){o[e]=s=P.bind(a,{},e),i.on(e,s),n.on(e,s)}),n.comparator=this._fullComparator),"infinite"==e)for(var l=this.links={},c=r.firstPage,e=x(r.totalRecords/r.pageSize),u=0===c?g(0,e-1):e||c,h=r.firstPage;h<=u;h++)l[h]=this.url;else this.links&&delete this.links;return t.silent||this.trigger("pageable:state:change",r),t.fetch?this.fetch(p(t,"fetch","resetState")):this},hasPreviousPage:function(){var e=this.state,t=e.currentPage;return"infinite"!=this.mode?t>e.firstPage:!!this.links[t-1]},hasNextPage:function(){var e=this.state,t=this.state.currentPage;return"infinite"!=this.mode?t<e.lastPage:!!this.links[t+1]},getFirstPage:function(e){return this.getPage("first",e)},getPreviousPage:function(e){return this.getPage("prev",e)},getNextPage:function(e){return this.getPage("next",e)},getLastPage:function(e){return this.getPage("last",e)},getPage:function(e,t){var r=this.mode,s=this.fullCollection;t=t||{fetch:!1};var a=this.state,i=a.firstPage,n=a.currentPage,o=a.lastPage,l=a.pageSize,c=e;switch(e){case"first":c=i;break;case"prev":c=n-1;break;case"next":c=n+1;break;case"last":c=o;break;default:c=h(e,"index")}this.state=this._checkState(b({},a,{currentPage:c})),t.silent||this.trigger("pageable:state:change",this.state),t.from=n,t.to=c;a=(0===i?c:c-1)*l,l=s&&s.length?s.models.slice(a,a+l):[];return"client"!=r&&("infinite"!=r||u(l))||t.fetch?("infinite"==r&&(t.url=this.links[c]),this.fetch(p(t,"fetch"))):(this.reset(l,p(t,"fetch")),this)},getPageByOffset:function(e,t){if(e<0)throw new RangeError("`offset must be > 0`");e=h(e);e=i(e/this.state.pageSize);return 0!==this.state.firstPage&&e++,e>this.state.lastPage&&(e=this.state.lastPage),this.getPage(e,t)},sync:function(e,t,i){var n,o,l=this;return"infinite"==l.mode&&(n=i.success,o=l.state.currentPage,i.success=function(e,t,r){var s=l.links,a=l.parseLinks(e,b({xhr:r},i));a.first&&(s[l.state.firstPage]=a.first),a.prev&&(s[o-1]=a.prev),a.next&&(s[o+1]=a.next),n&&n(e,t,r)}),(w.sync||c.sync).call(l,e,t,i)},parseLinks:function(e,t){var s,a={},t=t.xhr.getResponseHeader("Link");return t&&(s=["first","prev","next"],_(t.split(","),function(e){var e=e.split(";"),r=e[0].replace(d,""),e=e.slice(1);_(e,function(e){var t=e.split("="),e=t[0].replace(l,""),t=t[1].replace(l,"");"rel"==e&&f(s,t)&&(a[t]=r)})})),a},parse:function(e,t){var r=this.parseState(e,S(this.queryParams),S(this.state),t);return r&&(this.state=this._checkState(b({},this.state,r))),this.parseRecords(e,t)},parseState:function(e,t,r,s){if(e&&2===e.length&&o(e[0])&&y(e[1])){var a=S(r),i=e[0];return _(v(p(t,"directions")),function(e){var t=e[0],r=e[1],e=i[r];C(e)||P.isNull(e)||(a[t]=i[r])}),i.order&&(a.order=+n(t.directions)[i.order]),a}},parseRecords:function(e,t){return e&&2===e.length&&o(e[0])&&y(e[1])?e[1]:e},fetch:function(a){a=a||{};var r=this._checkState(this.state),i=this.mode;"infinite"!=i||a.url||(a.url=this.links[r.currentPage]);var s=a.data||{},e=a.url||this.url||"";k(e)&&(e=e.call(this));var t=e.indexOf("?");-1!=t&&(b(s,function(e){for(var t={},r=decodeURIComponent,s=e.split("&"),a=0,i=s.length;a<i;a++){var n,o,l=(n=s[a].split("="))[0];null==(o=n[1])&&(o=!0),l=r(l),o=r(o),n=t[l],y(n)?n.push(o):t[l]=n?[n,o]:o}return t}(e.slice(t+1))),e=e.slice(0,t)),a.url=e,a.data=s;var e="client"==this.mode?m(this.queryParams,"sortKey","order"):p(m(this.queryParams,R(z.queryParams)),"directions"),n=P.clone(this);if(P.each(e,function(e,t){e=k(e)?e.call(n):e,null!=r[t]&&null!=e&&P.isUndefined(s[e])&&(s[e]=r[t])},this),r.sortKey&&r.order){var o=k(e.order)?e.order.call(n):e.order;if(y(r.order))for(s[o]=[],h=0;h<r.order.length;h+=1)s[o].push(this.queryParams.directions[r.order[h]]);else s[o]=this.queryParams.directions[r.order+""]}else r.sortKey||delete s[e.order];for(var l,c,u=v(p(this.queryParams,R(z.queryParams))),h=0;h<u.length;h++)c=(l=u[h])[1],null!=(c=k(c)?c.call(n):c)&&(s[l[0]]=c);if("server"==i)return w.fetch.call(this,a);var f=this,g=this.fullCollection,d=a.success;return a.success=function(e,t,r){r=r||{},C(a.silent)?delete r.silent:r.silent=a.silent;var s=e.models;"client"==i?g.reset(s,r):(g.add(s,b({at:g.length},b(r,{parse:!1}))),f.trigger("reset",f,r)),d&&d(e,t,r)},w.fetch.call(this,b({},a,{silent:!0}))},_makeComparator:function(s,a,i){var e=this.state;if(s=s||e.sortKey,a=a||e.order,s&&a)return i=i||function(e,t){return e.get(t)},function(e,t){var r=i(e,s),e=i(t,s);return 1===a&&(t=r,r=e,e=t),r===e?0:r<e?-1:1}},setSorting:function(e,t,r){var s=this.state;s.sortKey=e,s.order=t=t||s.order;var a=this.fullCollection,i=!1,n=!1;e||(i=n=!0);s=this.mode;r=b({side:"client"==s?s:"server",full:!0},r);e=this._makeComparator(e,t,r.sortValue),t=r.full,r=r.side;return"client"==r?t?(a&&(a.comparator=e),i=!0):(this.comparator=e,n=!0):"server"!=r||t||(this.comparator=e),i&&(this.comparator=null),n&&a&&(a.comparator=null),this}}),z=e.prototype;return e});