define(["commonService","analytics","lazyLoadService"],function(){"use strict";var u=null,w=null,p=null;IEA.service("ratingService",function(m,t,e){function n(){return this}return _.extend(n.prototype,{initialize:function(t){return u=new IEA.commonService,w=new IEA.Analytics,p=new IEA.LazyLoad,this},preRatings:function(t){var e=this;p.lazyLoadFeature(t.elm,function(){e.initRatings(t)})},initRatings:function(a){var t,e,r=this;$(document).ajaxSuccess(function(t,e,n){a.ratingReview&&"kritique"===a.ratingReview.serviceProviderName&&e.responseJSON&&e.responseJSON.Entities&&digitalData.page.pageInfo.pageName===e.responseJSON.Entities[0].EntityName&&r._updateDataLayer(e.responseJSON.Entities[0].AverageRating,e.responseJSON.Entities[0].ReviewCount)}),void 0===a.ratingReview||"true"!==a.ratingReview.enabled&&!a.ratingReview.enabled||(t=a.ratingReview.serviceProviderName,e=a.ratingReview.enabled,"kritique"!==t||"true"!==e&&!0!==e?"bazaarvoice"===t&&this._checkScriptBazaarVoice(a):(this._loadKQScript(a),this._checkKritiqueSettings(a)))},_loadKQScript:function(t){var e,n=t.ratingReview,a=n.brandId,r=t.brandName,i=n.localeId,o=n.apiKey,c=n.serviceURI,s=n.sitesource,d=n.id;0===$("script[src*='RR_widget_config.js']").length&&0===$("script[src*='RR_widget.js']").length&&(e=document.createElement("script"),t=document.getElementsByTagName("script")[0],n=document.createElement("script"),p.preLoader(t,!0),e.type="text/javascript",e.async=!0,e.id=d,e.src=c+"?brandid="+a+"&localeid="+i+"&apikey="+o+"&siteSource="+s,t.parentNode.insertBefore(e,t),IEA.currentInstance.getValue("addRRConfig")&&(n.type="text/javascript",n.async=!0,n.src=u.getJsConfigUrl(r)+"/config/RR_widget_config.js",t.parentNode.insertBefore(n,t)),p.preLoader(t,!1))},_loadBazaarVoiceScript:function(t,e){var t=t.ratingReview,n=document.createElement("script");p.preLoader(n,!0),n.type="text/javascript",n.async=!0,n.readyState?n.onreadystatechange=function(){"loaded"!==n.readyState&&"complete"!==n.readyState||(n.onreadystatechange=null,e())}:n.onload=function(){e()},n.src=t.serviceURI,document.querySelector("head").appendChild(n),p.preLoader(n,!1)},_kritiqueRatings:function(t){void 0!==t.widget&&t.widget.rrReloadWidget()},_checkScriptBazaarVoice:function(t){var n=this;function e(e){e.ratingObj&&"primary"===e.ratingObj.viewType&&$BV.configure("global",{events:{bvRender:function(t){n._ctProductInfo(e,"render"),n._updateDataLayer($(".bv_avgRating").text(),$(".bv_numReviews_text").text().replace(/[()]/g,""))},submissionLoad:function(t){n._ctProductInfo(e,"open")},submissionClose:function(t){n._ctProductInfo(e,"close")},submissionSubmitted:function(t){n._ctProductInfo(e,"reviews")}}})}0===$("script[src*='bv.js']").length?this._loadBazaarVoiceScript(t,function(){window.$BV&&e(t)}):window.$BV&&"object"==typeof $BV?e(t):$("script[src*='bv.js']").on("load",function(){window.$BV&&e(t)})},_trackCurrentComponent:function(t,a){var r=this;$(document).on("click",t,function(){var t=$(this).parents("[data-componentname]"),e=(t.data("componentname")?t:$(a.elm)).data("componentname"),n=$(a.elm).data("componentname");ratingReview.events=ratingReview.events||{},event&&event.target&&((t=$(event.target).parents(".rr-widget-container"))&&t.length&&(a.productName=t.attr("title"),a.productId=t.data("uniqueId"))),e===n&&$.extend(ratingReview.events,{rrRender:function(){r._ctProductInfo(a,"render")},rrWriteReview:function(){r._ctProductInfo(a,"open")},rrFormClose:function(){r._ctProductInfo(a,"close")},rrHelpful:function(){r._ctProductInfo(a,"helpful")},rrUnHelpful:function(){r._ctProductInfo(a,"nothelpful")},rrReported:function(){r._ctProductInfo(a,"reported")},rrSubmitReview:function(){r._ctProductInfo(a,"reviews")},rrSubmitMultipleReviews:function(){r._ctProductInfo(a,"submitmultiplereviews")}})})},_checkKritiqueSettings:function(t){var n=this;function e(t){var e=t.elm.parent().attr("id");n._trackCurrentComponent("#"+e+" .write-review-btn, #"+e+" .wRtng",t),n._trackCurrentComponent("#rr-modalWidowcontainer .closeButton",t),n._trackCurrentComponent(".helpful",t),n._trackCurrentComponent(".un-helpful",t),n._trackCurrentComponent(".report-btn",t),n._trackCurrentComponent(".tReview",t)}0===$("script[src*='RR_widget.js']").length?this._loadKQScript(t,function(){e(t)}):$("script[src*='RR_widget.js']").on("load",function(){e(t)})},_ctProductInfo:function(t,e){var n,a,r,i,o,c,s,d,u,p,l,v,g=t.ratingReview.serviceProviderName,f={};if("undefined"!=typeof digitalData&&"undefined"!=typeof ctConstants){switch(w.trackComponentInfo(t.elm,digitalData),e){case"open":n="bazaarvoice"===g?ctConstants.bvopen:ctConstants.rrOpen;break;case"render":n="bazaarvoice"===g?ctConstants.bvrenders:ctConstants.rrRenders;break;case"close":n="bazaarvoice"===g?ctConstants.bvclose:ctConstants.rrClose;break;case"reviews":case"submitmultiplereviews":n=ctConstants.ratingreview;break;case"helpful":n="bazaarvoice"===g?"":ctConstants.rrHelpful;break;case"nothelpful":n="bazaarvoice"===g?"":ctConstants.rrNotHelpful;break;case"reported":n="bazaarvoice"===g?"":ctConstants.rrReported;break;case"read":n=ctConstants.readReviews}t.recipes||t.recipeId?(v=t.recipeName,u=t.recipes||t.recipeId,digitalData.product=[],digitalData.product.push({productInfo:{productID:u,productName:v}}),f.eventInfo={type:ctConstants.trackEvent,eventAction:n,eventLabel:v,eventValue:1}):(a=t.productId,r=t.productName,i=void 0!==t.productCategory?t.productCategory:"",o=t.productVariants,c=$(".rr-product-reviews"),s=$(".c-product-overview"),d=$(".js-product-images-thumbnail"),u=$(".c-reviews ul li[data-productid]"),p=[],l=[],v=[],t=[],c.length&&(a=c.attr("data-unique-id"),c.siblings("#productName").length?(r=c.siblings("#productName").val(),o=c.data("product-variant")):s.length?(r=s.data("product-name"),o=s.data("product-variant")):d.length?(r=d.data("product-name"),o=d.data("product-variant")):c.data("entity-name")&&c.data("entity-name").length&&(r=c.data("entity-name"),o=c.data("product-variant")),1<u.length&&("render"===e?(u.each(function(){p.push($(this).attr("data-productid")),l.push($(this).find("h4.product-name").text().trim())}),r=l.join(" | ")):"submitmultiplereviews"===e&&(u.each(function(){var t=$(this);t.find("li:first input").hasClass("valid")&&t.find("textarea").hasClass("valid")&&t.find(".postReviewStarRating input").hasClass("valid")&&(p.push(t.attr("data-productid")),l.push(t.find("h4.product-name").text().trim()))}),r=l.join(" | ")),v=p.join(" | "),t=l.join(" | "))),digitalData.product=[],1<u.length?digitalData.product.push({productInfo:{productID:v,productName:t},category:{primaryCategory:i},attributes:{productVariants:o}}):digitalData.product.push({productInfo:{productID:a,productName:r},category:{primaryCategory:i},attributes:{productVariants:o}}),f.eventInfo={type:ctConstants.trackEvent,eventAction:n,eventLabel:r,eventValue:1},"render"===e&&(f.attributes={nonInteractive:{nonInteraction:1}})),f.category="render"===e?{primaryCategory:ctConstants.custom}:{primaryCategory:ctConstants.advocacy},f.subcategory="render"===e?"Read":"close"===e?"Others":"Interest","bazaarvoice"===m&&"render"===e&&(f.attributes={nonInteractive:{nonInteraction:1}}),digitalData.event.push(f)}},_updateDataLayer:function(t,e){e&&window.digitalData&&(window.digitalData.page.entity?(window.digitalData.page.entity.ratings=t,window.digitalData.page.entity.reviewCount=e):window.digitalData.page.entity={ratings:t,reviewCount:e})}}),n})});