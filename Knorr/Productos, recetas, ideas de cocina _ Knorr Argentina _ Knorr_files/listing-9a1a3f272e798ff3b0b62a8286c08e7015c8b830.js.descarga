define(function(){"use strict";IEA.service("Listing",function(e,t,a){function i(){return this}var r=null;return _.extend(i.prototype,{initialize:function(){return r=new IEA.commonService,this},handleLoadMore:function(e,t){var a=e,i=a.defaultSettings,e=function(e){var t=$(window).scrollTop()+$(window).height();a.$el.offset().top+a.$el.height()+a.$el.find(i.loadmoreBtn).height()<=t&&2<=a.pageNum&&a.pageScroll&&(a.pageScroll=!1,a.$el.find(i.loadmoreBtn).click())};t?document.addEventListener("scroll",_.throttle(e,1e3,{trailing:!0,leading:!0})):document.addEventListener("scroll",e)},getUrlParameter:function(e){for(var t,a=window.location.search.substr(1).split("&"),i="",r=0;r<a.length;r++)(t=a[r].split("="))[0]===e&&(i=t[1]);return i},setFilterQueryParams:function(e,s){var t,d=e,f=this,a="",p="",g="",i="",r="",c=d.isRecipes?d.componentJson.recipeConfig:d.componentJson,u=1,m=!1,n=window.location.search,e=d.filterId+"="+f.getUrlParameter(d.filterId),h=f.getUrlParameter(d.filterId).split(d.urlSeprator);return d.defaultSettings.filtertags&&$(d.defaultSettings.filtertags).html(""),d.$el.find(d.defaultSettings.filterWrapper).each(function(e,t){if($(this).parents(d.defaultSettings.filterContainer).is(":visible")||$(this).parents(d.defaultSettings.sortWrapper).is(":visible")){var a=$(this),i=a.data("filter-type"),r=a.data("filter-option"),n="",l="",o=1<u?d.urlSeprator:"";switch(i){case"dropdown":n=f.getDropdownFilterValue(a,!0),l=f.getDropdownFilterValue(a,!1);break;case"radioButton":case"checkBox":n=a.is(":checked")?a.val():"",l=a.data("label");break;case"triStateButtonGroup":n=a.is(":checked")?r+"~"+a.val():"",l=a.data("filter-heading")+": "+a.data("label");break;case"multiValueButtonGroup":n=f.getMultiValueFilterValues(a,c),l=a.data("filter-heading")+": "+a.data("label");break;case"rangeFinder":n=f.getRangeFilterValues(a,c,!0),l=f.getRangeFilterValues(a,c,!1)+" "+a.data("label")}l=n.trim()?l.trim():"",!1===d.pushHistory&&l!==decodeURIComponent(h[u-1])&&(n=""),""!==n?a.data("filter-action")&&"sort"===a.data("filter-action")?"history"!==s&&(g+=c.sortConfig.sortParams.sortingCategory+"="+n+"&"):(m=!0,void 0!==s&&"history"===s?p+=o+l:g+=f.filterParamNameHandler(c,i)+"="+n+"&"):void 0!==s&&"history"===s&&"sort"!==a.data("filter-action")&&(p+="dropdown"===i?o+l:o+(l="")),d.isRecipes&&!a.data("filter-action")&&d._renderFilterTags(a,n,l),u++}}),d.isRecipes?(i=c.sortConfig.sortParams.pageIndex+"="+d.pageNum+"&",t=c.filterConfig.pageNoParamName+"="+c.pagination.itemsPerPage+"&",r=c.sortConfig.sortParams.pageSize+"="+c.pagination.itemsPerPage):t=c.filterConfig.pageNoParamName+"="+d.pageNum,"history"===s?(p=m?p:"",a+=n=-1<n.indexOf(e)?n.replace(e,d.filterId+"="+encodeURIComponent(p)):n?n+"&"+d.filterId+"="+encodeURIComponent(p):m?"?"+d.filterId+"="+encodeURIComponent(p):""):a+="?"+g+t+i+r,a},setRecipeMigrationFilterQueryParams:function(e){var l=this,o={};return e.$el.find(e.defaultSettings.filterWrapper).each(function(e,t){var a=$(this),i=a.data("filter-type"),r=a.data("filter-option"),n="";switch(i){case"dropdown":n=l.getDropdownFilterValue(a,!0);break;case"radioButton":n=a.is(":checked")?a.val():"";break;case"checkBox":n=l.getCheckBoxFilterValue(a)}""!==n&&(o[r]=n)}),o},setRecipeFilterQueryParams:function(e,s){var t,d=e,f=this,a="",p="",g="",i="",r="",n="",c=d.isRecipes?d.componentJson.recipeConfig:d.componentJson,u=1,m=!1,l=window.location.search,e=d.filterId+"="+f.getUrlParameter(d.filterId),h=f.getUrlParameter(d.filterId).split(d.urlSeprator);return d.defaultSettings.filtertags&&"history"!==s&&$(d.defaultSettings.filtertags).html(""),d.$el.find(d.defaultSettings.filterWrapper).each(function(e,t){var a=$(this),i=a.data("filter-type"),r=a.data("filter-option"),n="",l="",o=1<u?d.urlSeprator:"";switch(i){case"dropdown":n=f.getDropdownFilterValue(a,!0),l=f.getDropdownFilterValue(a,!1);break;case"radioButton":case"checkBox":n=a.is(":checked")?a.val():"",l=a.data("label");break;case"triStateButtonGroup":n=a.is(":checked")?r+"~"+a.val():"",l=a.data("filter-heading")+": "+a.data("label");break;case"multiValueButtonGroup":n=f.getMultiValueFilterValues(a,c),l=a.data("filter-heading")+": "+a.data("label");break;case"rangeFinder":n=f.getRangeFilterValues(a,c,!0),l=f.getRangeFilterValues(a,c,!1)+" "+a.data("label")}l=n.trim()?l.trim():"",!1===d.pushHistory&&l!==decodeURIComponent(h[u-1])&&(n=""),""!==n?a.data("filter-action")&&"sort"===a.data("filter-action")?"history"!==s&&(g+=c.sortConfig.sortParams.sortingCategory+"="+n+"&",d.sortElmVal=n):(m=!0,void 0!==s&&"history"===s?p+=o+e+"-"+l:g+=f.filterParamNameHandler(c,i)+"="+n+"&"):void 0!==s&&"history"===s&&"sort"!==a.data("filter-action")&&(p+="dropdown"===i?o+l:l=""),!d.isRecipes||a.data("filter-action")||d.componentJson.isMigrationEnabled||d._renderFilterTags(a,n,l),u++}),d.isRecipes&&!d.componentJson.isMigrationEnabled?(i=c.sortConfig.sortParams.pageIndex+"="+d.pageNum+"&",t=c.filterConfig.pageNoParamName+"="+c.pagination.itemsPerPage+"&",r=c.sortConfig.sortParams.pageSize+"="+c.pagination.itemsPerPage,""!==d.sortElmVal&&(n=c.sortConfig.sortParams.sortingCategory+"="+d.sortElmVal+"&")):t=c.filterConfig.pageNoParamName+"="+d.pageNum,"history"===s?(p=m?p:"",a+=l=-1<l.indexOf(e)?l.replace(e,d.filterId+"="+encodeURIComponent(p)):l?l+"&"+d.filterId+"="+encodeURIComponent(p):m?"?"+d.filterId+"="+encodeURIComponent(p):""):a+="?"+n+g+t+i+r,a},validateTriggerPoint:function(e,t,a){e>=a.length&&(e=a.length-1);for(var i=e;0<=i;i--){var r=$(a[i]),n=decodeURIComponent(t[i]).toLowerCase(),l=r[0].tagName.toLowerCase();if(1<=n.indexOf("-")&&(n=n.substr(n.indexOf("-")+1,n.length)),"select"===l){if(r.find("option").filter(function(){return $.trim($(this).text()).toLowerCase()===n}).length)return i}else{r=$.trim(r.parents("label").text()).toLowerCase();if(n===r)return i}}},filterParamNameHandler:function(e,t){var a;switch(t){case"multiValueButtonGroup":a=e.filterConfig.kiloCalFilterParam;break;case"rangeFinder":a=e.filterConfig.cookingTimeFilterParam;break;case"triStateButtonGroup":a=e.filterConfig.dietaryFilterParam;break;default:a=e.filterConfig.filterParamName}return a},getDropdownFilterValue:function(e,t){var a,i=e.data("filter-option"),r=e.find("option:selected").val(),n=e.find("option:selected").text(),e=e.data("filter-heading"),n="p_serves"!==i&&"p_makes"!==i||!r?(a=r,n):(a=i+"~"+r,e+": "+n);return t?a:n},getRangeFilterValues:function(e,t,a){var i="",r="",n=e.data("slider-min"),l=e.data("slider-max"),o=e.data("filter-option"),s=e.data("filter-heading"),e=e.slider("getValue");return!e.length||e[0]===n&&e[1]===l||(i=o+"~"+e[0]+"&"+t.filterConfig.cookingTimeFilterParam+"="+o+"~"+e[1],r=s+": "+e[0]+"-"+e[1]),a?i:r},getMultiValueFilterValues:function(e,t){var a="",i=e.data("filter-option");return e.is(":checked")&&(a=i+"~"+(e=e.val().split("~"))[0]+"&"+t.filterConfig.kiloCalFilterParam+"="+i+"~"+e[1]),a},filtersHandler:function(e,t){var a=t,t=$(e.currentTarget),e="is-default-val";a.$el.find(a.defaultSettings.filterBlock).addClass(e),t.hasClass("active-dropdown")&&(a.activeState=!1),a.activeState||(""!==t.val()?(t.parents(a.defaultSettings.filterContainer).find(a.defaultSettings.filterBlock).removeClass(e),t.addClass("active-dropdown"),a.selectedFiltersIndex=a.$el.find(a.defaultSettings.filterBlock+"."+e).data("index")):(t.removeClass("active-dropdown"),a.activeState=!1)),a.pageNum=a.defaultSettings.startPageNum,a.isPageLoad=!0,$(a.preloaderContent).removeClass("hidden").show(),a._populateData()},updateFilters:function(e,t){var a=e,i=a.defaultSettings,r=a.getTemplate("listing-v2-filters",i.filterTemplate),n=t.filterConfig.filterOptions[a.selectedFiltersIndex],e=i.filterBlock+'[data-index="'+a.selectedFiltersIndex+'"]',i=i.filterContainer;n&&(n.index=a.selectedFiltersIndex),a.activeState||(n&&$(n.filters).length?a.$el.find(e).html(r(n)).parents(i).show():a.$el.find(e).parents(i).hide(),a.activeState=a.$el.find(a.defaultSettings.filterBlock+".is-default-val").length!==t.filterConfig.filterOptions.length)},animateResults:function(e,t,a,i){"show"===i?($(e).animate({opacity:1,top:0},800),$(t).fadeOut(a)):($(e).animate({opacity:1,top:"30px"},800),$(t).fadeIn(a))},pagination:function(e,t,a){var i=t,r=i.data("role"),n="o-btn--disabled",l=a.$el.find(e+'[data-role="first"]'),o=a.$el.find(e+'[data-role="last"]'),s=a.$el.find(e+'[data-role="next"]'),d=a.$el.find(e+'[data-role="prev"]'),f=a.isRecipes?a.componentJson.recipeConfig:a.componentJson,t=a.defaultSettings.pageNavCount;switch(a.$el.find(e).removeClass("o-btn--active"),r){case"first":a.pageNum=parseInt(i.data("pagenum")),a.startIndex=a.pageNum;break;case"last":case"navigation":a.pageNum=parseInt(i.data("pagenum")),a.startIndex=f.pagination.itemsPerPage*(a.pageNum-1)+1;break;case"next":a.pageNum++,a.startIndex=a.startIndex+f.pagination.itemsPerPage;break;case"prev":a.pageNum--,a.startIndex=a.startIndex-f.pagination.itemsPerPage}a.pageNum===parseInt(o.data("pagenum"))?(s.addClass(n),o.addClass(n),l.removeClass(n),d.removeClass(n)):(a.pageNum===parseInt(l.data("pagenum"))?(l.addClass(n),d.addClass(n)):(l.removeClass(n),d.removeClass(n)),s.removeClass(n),o.removeClass(n)),a.$el.find(e+"[data-pagenum="+a.pageNum+"]").addClass("o-btn--active"),this.updateNavCount(a,r,t)},generatePagination:function(e,t,a,i){var r,n=t,l=n.getTemplate("pagination",n.defaultSettings.paginationTemplate),o=i.itemsPerPage,s=Math.ceil(e/o),d=[],f=t.defaultSettings.pageNavCount,p="hidden";if(o&&s){for(var g=0;g<s;g++)d.push(g);r={componentJson:n.componentJson,pageNum:n.pageNum||n.defaultSettings.pageNum,totalPages:s,paginate:d},n._updateParamsOnPageScroll(e),a&&"pagination"===i.paginationType&&$(n.pagination).html(l(r)),o<e?($(n.pagination).removeClass(p),$(n.loadmoreWrapper).removeClass(p),1===n.pageNum&&n.$el.find(n.defaultSettings.loadmoreBtn).fadeIn()):($(n.pagination).addClass(p),$(n.loadmoreWrapper).addClass(p)),a&&f&&this.setNavCount(n.pagination,f,t)}},setNavCount:function(e,t,a){a=a.$el.find(".js-pagination-numbers");$(a.addClass("hidden").splice(0,t)).removeClass("hidden")},updateNavCount:function(e,t,a){var i,r=e.$el.find(".js-pagination-numbers"),n=e.pageNum;switch(t){case"first":$(r.addClass("hidden").splice(0,a)).removeClass("hidden");break;case"last":r.addClass("hidden"),$(_.last(r,a)).removeClass("hidden");break;case"next":$(r[n]).add($(r[n-1])).removeClass("hidden"),(i=$(r).filter(":visible")).length>a&&i.first().addClass("hidden");break;case"prev":$(r[n-2]).add($(r[n-1])).removeClass("hidden"),(i=$(r).filter(":visible")).length>a&&i.last().addClass("hidden");break;case"navigation":$(r[n-1]).removeClass("hidden"),$(r[n]).hasClass("hidden")?($(r[n]).removeClass("hidden"),(i=$(r).filter(":visible")).length>a&&i.first().addClass("hidden")):$(r[n-1]).prev().hasClass("hidden")&&($(r[n-1]).prev().removeClass("hidden"),(i=$(r).filter(":visible")).length>a&&i.last().addClass("hidden"))}},_filtersViewHandler:function(e){var t=e,a=!!r.isMobile(),e=$(t.filtersCollapsibleWrapper).find(t.defaultSettings.filterContainer);a&&($(t.showHideFilterCl).show(),$(t.showHideFilterOptionsCl).hide(),$(t.filterBlockWrapper).addClass(t.defaultSettings.filterCollapsedCl),$(e).removeClass(t.defaultSettings.filtersCollapsedCl))},_toggleFilterOptions:function(e,t){var a=e,i=t.data("collapsed-state"),e=i?a.componentJson.filterConfig.hideFilterOptionsLabel:a.componentJson.filterConfig.showFilterOptionsLabel;$(a.filterBlockWrapper).toggle(),t.html(e),t.data("collapsed-state",!i)},_filterApplyHandler:function(e){e.activeState=!0,e.pageNum=e.defaultSettings.startPageNum,e.isPageLoad=!0,$(e.preloaderContent).removeClass(e.hiddenClass).show(),e._populateData()},_filterClearHandler:function(e){$(e.filterBlock).find("select").prop("selectedIndex",0),$(e.filterBlock).find("input").prop("checked",!1),e._populateData()},_filterShowHideMoreHandler:function(e,t){var a=e,i=t.data("collapsed-state"),e=i?a.componentJson.filterConfig.showLessFiltersLabel:a.componentJson.filterConfig.showMoreFiltersLabel;t.parent(a.defaultSettings.filterBlockWrapper).find(a.defaultSettings.filtersCollapsedWrapper).toggle(),t.html(e),t.data("collapsed-state",!i)},getCheckBoxFilterValue:function(e){var e=e.parents(".o-filter-checkbox").children().find(".c-listing-filter__filter"),a=[];return e.each(function(e,t){$(this).is(":checked")&&a.push($(this).val())}),a=a.join("|")}}),i})});