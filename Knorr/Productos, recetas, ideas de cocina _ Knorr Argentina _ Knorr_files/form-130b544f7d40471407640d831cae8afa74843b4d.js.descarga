define(["commonService","analytics"],function(){"use strict";var d=new IEA.commonService,u=new IEA.Analytics;IEA.service("formService",function(e,t,r){function v(){return this}return _.extend(v.prototype,{initialize:function(){return this},fieldToJson:function(e,r,a){var n,o=this;e&&(n=e,$.each(r,function(e){var t;o.isArray(r[e])||(t=e+1===r.length,n=o.addObject(n,r[e],r[e-1],r[e+1],t),r.length===e+1&&o.addValue(n,r[e],a))}))},surveyFieldToJson:function(e,r,a,n){var o,s=this,i=n.attr("name"),l=$("#"+i).val(),c=n.siblings('input[type="text"]').val();e&&(o=e,$.each(r,function(e){var t;s.isArray(r[e])||(t=e+1===r.length,o=s.addObject(o,r[e],r[e-1],r[e+1],t),r.length===e+1&&("answerText"===r[e]?a=c||"":"id"===r[e]?a=l||"":"answer"===r[e]?a=null!==n.val()&&""!==n.val():"answerType"===r[e]&&(a=i||""),s.addValue(o,r[e],a)))}))},addObject:function(e,t,r,a,n){if(e.constructor===Array){for(var o={},s=this.isArray(a)?void 0===e[r]?(o[t]=[],o[t]):o=e[r]:(null!==e[r]&&void 0!==e[r]?o[t]=e[r]:o[t]={},n?o:o[t]);e.length<parseInt(r);)e.push({});e.splice(parseInt(r),0,o)}else{o=!1;this.isArray(a)?null!==e[t]&&void 0!==e[t]?e=e[t]:(o=!0,e[t]=[]):null!==e[t]&&void 0!==e[t]?e=e[t]:(o=!0,e[t]={}),s=n||e.constructor&&!o?e.constructor===Array&&void 0!==e[a]?e[a]:e:e[t]}return s},makeFieldMandatory:function(e,n,t){var a=arguments,o=function(){for(var e=[],t=2,r=0;t<a.length;t++)e[r]=a[t],r++;return e}();$(document).on("change",e,function(){var r,e='label[for="'+n+'"]',a=$(this),t=$(e).find(".c-form-mandatory");(r=!1,o.forEach(function(e,t){r=r||a.find('option[value="'+e+'"]').is(":selected")}),r)?(t.length?t.show():$(e).append('<span class="c-form-mandatory">*</span>'),$(document).trigger("makeMandatoryEvent",[n,!0])):(t.hide(),$(document).trigger("makeMandatoryEvent",[n,!1]))})},addValue:function(e,t,r){e.constructor!==String&&(r instanceof String||"string"==typeof r?e[t]=$.trim(r):e[t]=r)},isArray:function(e){return $.isNumeric(e)},formToJson:function(e){e=$(e);return this.convertToJSON({},e.find("input, textarea, select").not("[data-exclude]"),this)},removeBlankElements:function(e){for(var t=[],r=0;r<e.length;r++){var a,n=!0;for(a in e[r])e[r].hasOwnProperty(a)&&(n=!1,e[r][a]=this.cleanArray(e[r][a]));n||t.push(e[r])}return t},cleanArray:function(e){return null===e||(e.constructor===Array?e=this.removeBlankElements(e):e.constructor===Object&&(e=this.removeEmptyArrayElements(e))),e},removeEmptyArrayElements:function(e){for(var t in e)e.hasOwnProperty(t)&&(e[t]=this.cleanArray(e[t]));return e},convertToJSON:function(m,e,h){return m={},e.each(function(e){var t=$(this);if("submit"!==t.attr("name")){var r=t.val(),a=t.attr("type"),n=t.attr("name"),o=t.attr("id"),s=t.data("field-id"),i=t.data("type"),l=t.data("survey-field");switch(a){case"checkbox":t.data("sample")?this.checked&&h.fieldToJson(m,n.split("-"),r):h.fieldToJson(m,n.split("-"),this.checked);break;case"radio":l&&(o=t.data("id"),h.fieldToJson(m,o.split("-"),this.checked)),this.checked&&!l&&($.isNumeric(r)&&"number"===i&&(r=parseInt(r)),h.fieldToJson(m,n.split("-"),r));break;case"file":m[o]=t.data("fileencoded");break;case"number":$.isNumeric(r)&&(r=parseInt(r)),h.fieldToJson(m,n.split("-"),r);break;default:if(n){var c=n.split("-"),d=[],u=null,p=t.hasClass("c-form-survey-field");if(p&&(c=(t.hasClass("c-form-dropdown")?n:s||o).split("-")),$.each(c,function(e){d=d.concat(c[e].split("#"))}),"boolean"===i){var f="true"===r;return void h.fieldToJson(m,n.split("-"),f)}$.isNumeric(r)&&"number"===i&&(r=parseInt(r)),t.is(".input-date")&&($("body").hasClass("registration-page")||$("body").hasClass("profile-page"))&&"mm/dd/yyyy"!==t.attr("data-format")&&(""===t.val()?u="":r=h.getFormattedDate(r,"mm/dd/yyyy",t.attr("data-format"))),p?v.prototype.surveyFieldToJson(m,d,u,t):v.prototype.fieldToJson(m,d,null!==r&&""!==r?r:u)}}}}),h.removeEmptyArrayElements(m),JSON.stringify(m)},jsonToForm:function(e){var s={},i=[];return function n(e,o){$.each(e,function(e,t){if(i[o]=e,null!==t)if("object"==typeof t)n(t,o+1);else{for(var r="",a=0;a<o;a++)r+=i[a]+"-";s[r+=e]=t}})}(e,0),s},getFormattedDate:function(e,t,r){var a=-1!==e.indexOf("-")?e.replace(/-/g,"/"):e,e=r&&r!==t?new Date(a.replace(/(\d{2})\/(\d{2})\/(\d{4})/,"$2/$1/$3")):new Date(a),r=e.getMonth()+1,a=e.getDate(),e=e.getFullYear(),o="",s=[];if(1===a.toString().length&&(a="0"+a),1===r.toString().length&&(r="0"+r),s.push("dd:"+a),s.push("mm:"+r),s.push("yyyy:"+e),void 0!==t)return e=t.split(new RegExp("[-./:? ]","g")),_.each(e,function(r,a){var n=-1!==t.indexOf("-")?"-":"/";_.each(s,function(e,t){-1!==e.indexOf(r)&&(o+=0===a?e.split(":")[1]:n+e.split(":")[1])})}),o},groupPrefilledData:function(e,t){var r="."+t,a="hidden",n=".form-group",o=e.find(".c-preview-block"),t=e.find(n);e.find(r).length?(e.find(r).parents(n).each(function(){var e=$(this);e.clone().removeClass(n).prependTo(o).insertAfter(".c-edit-link"),e.addClass("hidden")}),o.find("input, select").each(function(){var e,t=$(this);"checkbox"===t.attr("type")||"radio"===t.attr("type")?(e=t.attr("type"),t.replaceWith("<input type='"+e+"' class='prev-elem' checked='true' disabled='true'>")):t.hasClass("c-form-dropdown")?t.replaceWith("<div class='prev-elem'>"+t.find("option:selected").text()+"</div>"):t.replaceWith("<div class='prev-elem'>"+t.val()+"</div>")})):t.hasClass(a)&&t.removeClass(a),e.hasClass("editable")?o.addClass(a):o.removeClass(a)},profileDateDropdown:function(e,t){var r=new Date(t),a=r.getMonth()+1,t=r.getDate(),r=r.getFullYear();1===a.toString().length&&(a="0"+a),1===t.toString().length&&(t="0"+t),e.find("[name*=Date]").val(t),e.find("[name*=Month]").val(a),e.find("[name*=Year]").val(r)},populateFormData:function(e,o){var s=this,i="form-elem-preview",t=o.find("[name*=Birthday]");$.each(e,function(e,t){var r,a,n;0<o.find("[name*="+e+"]").length&&""!==t?("checkbox"===(r=(n=$("[name*="+e+"]")).attr("type"))&&!0===t?(n=$("[name="+e+"]")).attr("checked",!0):"radio"===r?($("body").hasClass("profile-page")?$("#"+t):$("#"+e+"-"+t)).attr("checked",!0):(n=$("[name="+e+"]"),-1!==e.toLowerCase().indexOf("birthday")?(a="yyyy/mm/dd",n.attr("data-format")&&(a=n.attr("data-format")),n.data("date-picker")?require(["datepicker"],function(){n.val(s.getFormattedDate(t.split("T")[0],a)).datepicker("setDate",new Date(t))}):n.val(s.getFormattedDate(t.split("T")[0],a))):n.hasClass("c-form-dropdown")&&!o.hasClass("editable")?(n.find("option:selected").removeAttr("selected"),n.find('option[value="'+t+'"]').prop("selected",!0)):n.val(t)),o.hasClass("hideFieldsWithProfileData")?n.closest(".component-wrapper").hide():o.hasClass("preFillFieldsWithProfileData")&&(n.hasClass(i)?n.removeClass(i):n.addClass(i))):""!==t&&-1!==e.toLowerCase().indexOf("surveyid")&&d.dispatchEvent("surveyLoaded",t)}),s.profileDateDropdown(o,t.val()),o.hasClass("preFillFieldsWithProfileData")&&s.groupPrefilledData(o,i)},getCookie:function(e){return(document.cookie.match("(^|; )"+e+"=([^;]*)")||0)[2]},matchConfirmPassword:function(e,t,r,a,n){var o=t,t=r,r=t.parents(".form-group"),e=t.parent().find(e.errorMsgFieldWrapper);return""!==o.val()&&""!==t.val()&&o.val()!==t.val()?(r.addClass("has-error pwd-has-error-block"),e.html(a).removeClass("hidden"),!1):(r.removeClass("has-error pwd-has-error-block"),e.addClass("hidden"),n&&this.registrationHelpers().moveNext(),!0)},fetchFacebookDetails:function(a){this.fbConnectCookieName="facebook-connect";var e=d.getCookie(this.fbConnectCookieName);if("undefined"!=typeof FB&&null!==FB&&e)return FB.getLoginStatus(function(e){var t,r;a=JSON.parse(a),this.providerName=$(".o-btn__social-login").data("provider-name"),"connected"===e.status&&(t=[],r={Provider:this.providerName,ProviderUserId:e.authResponse.userID},t.push(r),a.OAuthMemberships=t,a.token=e.authResponse.accessToken),a=JSON.stringify(a)}),a},validationHelpers:function(o){var a=this;return{fielUploadRequired:function(){var e=$(o.formFile),t=e.parents(o.formGroup);return""===e.val()||t.hasClass(o.fileError)?(t.addClass(o.fileError),e.next(o.fileHelpBlock).removeClass("hidden"),!1):(t.removeClass(o.fileError),e.next(o.fileHelpBlock).addClass("hidden"),!0)},confirmPassword:function(){if($("body").hasClass("profile-page")||$("body").hasClass("reset-password-page")){var e=$('[name="NewCredentials-confirmPassword"]').data("form-profile-confirm-password-msg-msg"),t=$('[name="NewCredentials-Password"]'),r=$('[name="NewCredentials-confirmPassword"]');return a.matchConfirmPassword(o,t,r,e)}return!0},passwordMismatch:function(e){if($("body").hasClass("profile-page")&&0<e.$form.find("#profileEmailPassword-submit").length){var t=e.$form.find('[name="OldCredentials-Password"]'),r=e.$form.find('[name="NewCredentials-Password"]'),a=r.parents(".form-group"),n=r.parent().find(o.errorMsgFieldWrapper),e=e.$form.find('[name="NewCredentials-Password"]').data("form-oldnewpasswordmismatch-msg");return""!==t.val()&&""!==r.val()&&t.val()===r.val()?(a.addClass("has-error pwd-mismatch-has-error-block"),n.html(e).removeClass("hidden"),!1):(a.removeClass("has-error pwd-mismatch-has-error-block"),n.addClass("hidden"),!0)}return!0}}},registrationHelpers:function(){var l=this;function t(){var e=$("form.active .c-registration-tab-content").height()+220;$("form.active").parents(".c-tab-element-wrapper-content").height(e),$(".form .form-error-message").remove()}function c(){$(".c-tab-element-wrapper-content").find(".form-error-msg").remove();var e=$("form.active");(e.parents(".form").length?e.parents(".form"):e.parents(".formV2")).next().find("form").addClass("active"),e.removeClass("active"),t(),$("form").find(".c-registration-tab-content").length&&$("html, body").animate({scrollTop:$("form.active .c-registration-tab-content").eq(0).offset().top-220},800)}return{moveNext:c,registerUser:function(r,a,e){var t=$(r).attr("action"),n=null,o=d.getLocalStorageItem("returnUrl"),s=$("#userPreferencesId-submit").parents("form"),i=$("#userDetailsId-submit").parents("form"),n="update"===$("#userPreferencesId-submit").attr("actionType")?(t=t.replace(/.create$/,".update"),$(i).add(s).find(":input").not("[type=submit]").not("[data-exclude]")):$('.c-tab-element-wrapper-content form :input:not([type="submit"])').not("[data-exclude]"),i=l.convertToJSON({},n,l),n=JSON.parse(i);l.fetchFacebookDetails(i)&&(i=l.fetchFacebookDetails(i)),(d.getLocalStorageItem("QuickpollSurveyResponses")||d.getLocalStorageItem(n.locale+"-diagnosticToolSignupSurveyResponses",!0))&&(i=l.registrationDataToPrm(n)),(n=$.ajax({type:$(".local-env").length?"GET":"POST",url:t,contentType:"application/json",dataType:"json",data:i,headers:{locale:n.locale,brand:n.brand}})).done(function(){"Success"!==arguments[0].Status||!arguments[0]["non-PII"]&&"undefined"==typeof FB||(u._trackFormSubmit(s,arguments[0]["non-PII"],l.providerName),e&&(e._registerationSubmitTracking(arguments[0]),e._registerationSuccessHandler()),d.getCookie(l.fbConnectCookieName)&&d.eraseCookie(l.fbConnectCookieName)),o&&""!==o?(d.removeLocalStorageItem("returnUrl"),window.location.href=o):c()}),n.fail(function(e){var t=$(r).find(".c-registration-tab-content");void 0===e.error||((e=JSON.parse(e.responseText)).errors?e.errors.length:0)&&(a&&e.code===a.errorCodes.captchaErrorCode?a._genericErrorCodeHandler(e,!0,t):a._genericErrorCodeHandler(e,!1,t))})},setFormHeight:t}},registrationDataToPrm:function(e){var t;return d.getLocalStorageItem("QuickpollSurveyResponses")&&(t=JSON.parse(d.getLocalStorageItem("QuickpollSurveyResponses")),e=JSON.stringify(this.createRegisterJson(t,e))),d.getLocalStorageItem(e.locale+"-diagnosticToolSignupSurveyResponses",!0)&&(t=JSON.parse(this.getMultipleLocalStorageMergedData("diagnosticToolSignupSurveyResponses",e.locale,!0)),e=JSON.stringify(this.createRegisterJson(t,e))),e},createRegisterJson:function(e,t){var r=t.Registrations[0].MarketingPreferences||!1,r=r&&void 0!==r.SurveyResponses?r.SurveyResponses.Responses.push(e.surveyResponseList.Responses):(r.SurveyResponses=e,r);return t.Registrations[0].MarketingPreferences=r,t},sendDataToPRM:function(e){var t,r=JSON.parse(e);return $(".sign-up-page").length&&(d.getLocalStorageItem("QuickpollSignupSurveyResponses")&&(t=JSON.parse(d.getLocalStorageItem("QuickpollSignupSurveyResponses")),e=JSON.stringify(this.createSignupJson(t,r))),d.getLocalStorageItem(r.locale+"-diagnosticToolSignupSurveyResponses",!0)&&(t=JSON.parse(this.getMultipleLocalStorageMergedData("diagnosticToolSignupSurveyResponses",r.locale,!0)),e=JSON.stringify(this.createSignupJson(t,r)))),e},createSignupJson:function(e,t){var r=t.surveyResponseList||!1,t=r?(r.push(e.surveyResponseList[0]),t):$.extend(e,t);return t},_addUtmParamData:function(e){var t=JSON.parse(e),e=window.location.search.substring(1);return e&&(t.utmParameters=encodeURIComponent(e)),JSON.stringify(t)},handleRememberMe:function(e){var t=$(e.currentTarget),r=$("#rememberMeExpiration"),a=$("#ExpirationDuration"),e=$("#defaultExpiration");t.is(":checked")&&r.length&&a.val(r.val()),!t.is(":checked")&&e.length&&a.val(e.val())},resetFormData:function(e,t,r){var a=this;e.preventDefault(),$("form").each(function(){this.reset(),a.populateFormData(t,r)})},getMultipleLocalStorageMergedData:function(r,e,t){if(d.getLocalStorageItem(e+"-"+r,t)){var a,e=JSON.parse(d.getLocalStorageItem(e+"-"+r,t)),n=[],t={};return $.each(e,function(e,t){switch(a=t,r){case"surveyResponses":n=n.concat(t.SurveyResponses.Responses[0].QuestionAnswers);break;case"diagnosticToolSignupSurveyResponses":n=n.concat(t.surveyResponseList[0].questionAnswersList);break;default:n=n.concat(t)}}),t="surveyResponses"===r?(a.SurveyResponses.Responses[0].QuestionAnswers=n,a):"diagnosticToolSignupSurveyResponses"===r?(a.surveyResponseList[0].questionAnswersList=n,a):n,JSON.stringify(t)}},handleDOMAttrChanges:function(e,t){var r=e.attr(t);void 0!==r&&!1!==r?e.removeAttr(t):e.attr(t,"disabled")}}),v})});