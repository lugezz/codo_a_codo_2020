define(["typeahead"],function(){"use strict";IEA.service("search",function(e,t,n){function a(){return this}return _.extend(a.prototype,{initialize:function(e){return this.options=_.extend({},e),this},showSuggestions:function(d,t){var s,r=this,h=d.dropDownLabel,o=$(d.searchWrapper).attr("data-keyword"),n={templateSuggestions:"partials/input-suggestions.hbss",selectCallback:function(){}},e=t.getModelJSON(),e=void 0!==e.searchListingV2?e.searchListingV2:{},e=void 0===e.additionalBrands?[]:e.additionalBrands,l=[];e&&_.each(e,function(e){l.push(e.name)}),d=$.extend(n,d),$(d.searchInputField).typeahead({hint:d.hint||!1,highlight:!0,minLength:d.minLengthToTriggerAutoSuggest||3},{name:"keywordSearch",limit:"Infinity",beforeSelectedVal:this.query,source:function(e,t,n){var a,i;d.autoSuggest&&(a=d.queryParams||"&Locale="+d.locale+"&BrandName="+d.brandName+"&ab="+l.join(","),i=d.isExternal,s=d.groupCall?d.servletUrl+d.groupQueryParams:o+"?q="+encodeURIComponent(e)+a,$.ajax(s,{beforeSend:function(e){i&&e.setRequestHeader("external-contents","recipe")},success:function(e,t){d.groupCall&&(d.groupCall=!1,$(".c-address-lookup .tt-menu").show()),$.isArray(e)?n(e):0<e.totalResults?n(e.response):e.responseData&&e.responseData.result&&n(e.responseData.result)}}))},templates:{suggestion:function(e){return t.getTemplate("input-suggestions",n.templateSuggestions)({data:e,suggestionImage:d.suggestionImage,formAddressEnabled:d.formAddressEnabled})}}},{name:"keywordSearchDefault",limit:d.suggestionsLimitDefault||3,source:function(n,e,t){var a,i,s,r,o,l,c;d.customKeyword&&(h||d.tabContentTypes)&&(a=[],r=s=i="",l=d.tabContentTypes||h,d.suggestContentTypes&&(c=!1,d.tabContentTypes&&d.tabContentTypes.length&&d.tabContentTypes.forEach(function(e){c=c||-1<n.indexOf(e.contentType)}),o=c),o=o||-1!==n.indexOf(h.inArticles)||-1!==n.indexOf(h.inProducts)||-1!==n.indexOf(h.inEverything)?n.split(" ")[0]:n,l.length?$(l).each(function(e,t){t=(d.inLabel||h)+" "+t.contentType;-1===n.indexOf(t)&&a.push(n+" "+t)}):(i=o+" "+h.inArticles,s=o+" "+h.inProducts,r=o+" "+h.inEverything,a.push(s),a.push(i),a.push(r)),e(a))}}).on("keydown",function(e){var t=e.key.toLowerCase(),e=$(this);"tab"!==t&&"arrowright"!==t||(t=e.typeahead("val"),t=r.isJSON(t)?JSON.parse(t):t,e.typeahead("val",t.Description||t))}).on("keyup",function(e){var t=$(this),n=e.key.toLowerCase();t.typeahead("val")&&!t.typeahead("val").match(/^\s*$/)?$(d.clearSearch).removeClass("hidden"):$(d.clearSearch).addClass("hidden"),d.keyupCallback&&"enter"===n&&d.keyupCallback(d,e,t.val()),r.shrinkToFill(t.next("pre"),d.inputFont,t)}).bind("typeahead:cursorchange ",function(e,t){var n=$(this);t&&t.Title?n.val(t.Title):t&&t.Description&&n.val(t.Description)}).bind("typeahead:beforeselect ",function(e,t){d.typedVal=$.trim($(this).val())}).bind("typeahead:selected",function(e,t,n){var a=$(this),i=a.val();try{d.searchKeyword=JSON.parse(i).Text}catch(e){d.searchKeyword=i}d.selectCallback(d,i,a),d.groupCall||(a.typeahead("close"),a.next("pre").text(d.searchKeyword),a.typeahead("val",d.searchKeyword+" "),a.val(d.searchKeyword),r.shrinkToFill(a.next("pre"),d.inputFont,a))}).bind("typeahead:render",function(e,t){var n=$(this),a=n.val().toLowerCase(),i=n.parent(),n=i.find(".tt-dataset-keywordSearch .tt-suggestion"),s=i.find(".tt-hint");s.hide(),n&&d.hint&&n.each(function(e,t){var n,t=t.innerText.toLowerCase();if(void 0!==d.tabContentTypes?n=d.tabContentTypes[e]:h?$.each(h,function(e,t){n=h[e].contentType}):n="",0===t.indexOf(a)&&-1===t.indexOf(n))return t.length===a.length&&s.val(""),s.show(),!1})})},isJSON:function(e){try{JSON.parse(e)}catch(e){return!1}return!0},measureText:function(e,t){e=$(e);return e.length&&e.css("font-size",t),{width:e.width(),height:e.height()}},shrinkToFill:function(e,t,n){var a=$(n),n=a.width()+5,e=this.measureText(e,t).width;n<e&&(t=t*n/e*".95"),a.css("font-size",t+"px")},clearSearchVal:function(e){var t=e.data.field||".c-global-search__form .typeahead",n=e.data.wrapper||"",t=""!==n?$(e.target).parents(n).find(t):$(t);e.preventDefault(),t.typeahead("close"),t.val("").typeahead("val","").focus(),t.next("pre").text(""),$(this).addClass("hidden")},setPageTitle:function(e,t){t=t&&t.tagTitle?t.tagTitle:e;t&&(0<=(e=document.title).indexOf("|")?document.title=t+" | "+e.split("|")[1]:document.title=t+" | "+e)}}),a})});